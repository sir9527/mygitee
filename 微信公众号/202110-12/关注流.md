

[TOC]

### 微信公众号关注实现架构



#### 1.表设计

**三张元数据表：**

用户表：订阅文章的用户信息表

作者表：写文章的用户信息表

文章表：作者发布的文章信息



**三张关联表：**

关注关系表：作者是用户的关注，用户是作者的粉丝

作者发件箱：作者写完文章保存文章的表

用户收件箱：用户订阅作者保存文章的表



#### 2.关注流架构演进

```

推模型和拉模型：
1.拉模型：读者先去关注关系表中，查询出所有的关注的作者。再去每一个作者的发件箱里把文章查询出来，还要按照时间顺序拼接，最终展示到手机上 
 
2.推模型（牺牲拉模型的写性能，提交读性能）：读者直接去自己的收件箱里，把文章一次性拿到。

```



##### 2.1 拉模式

刚开始的时候，公众号作者较少，阅读公众号的读者同样也较少 



拉模型：读者先去关注关系表中，查询出所有的关注的作者。再去每一个作者的发件箱里把文章查询出来，还要按照时间顺序拼接，最终展示到手机上 。



##### 2.2 推模型

公众号作者和阅读公众号的读者都增多。



读者每次用拉模式看文章，文章都需要查多张表，读性能太低，所以就让作者写完文章后直接将文章同步到用户收件箱中，读者读文章时直接去自己的收件箱里，把文章一次性拿到。只需要读一张表，牺牲了作者的写性能，提高了读者的读性能。



##### 2.3 延时推模型（冷热分离思想）

粉丝量破万的公众号号主，那它每发布一篇文章，就要推给相当多的读者。这种大牛号主每写一篇文章都需要同步太多粉丝的用户收件箱，写性能大幅度降低。



我们将用户分成两类，一类是**活跃用户**，经常刷公众号文章的，一类是**不活跃用户**，可能好几天才打开一次。

作者发布文章后，只立刻推给活跃用户，先不管那些非活跃用户。非活跃用户再次打开他的公众号关注流时，先触发文章的推送逻辑，将未同步到其收件箱的文章推过来，之后再走正常的逻辑，从自己的收件箱取出关注流数据。 



##### 2.4 推拉结合（冷热分离思想）

大 V 号：活跃粉丝太多。延时推模型还是解决不了，就需要推拉结合。



将作者分成**大 V 作者**和**普通作者** 。

1.大 V 作者不再推文章给粉丝了，仅仅保存在自己的发件箱里。

2.读者在刷新公众号关注流时，首先仍然是去自己的收件箱中，把文章全查出来，这是**推模型**。

3.之后，还要查出他所关注的公众号作者中，所有的大 V 作者（可以设置一个标识大V的字段）。如果没有，那到此为止，直接返回手机关注流数据进行展示。如果有，再去该大 V 作者的发件箱里，把文章查出来（注意，这里只查最近发的文章，有个时间限制，不然...），这是**拉模型**。

4.最后，把它们按照时间顺序，重新混合在一起，返回给手机端。



#### 3.微信公众号现状

从前的公众号列表，是完全按照时间进行排序的，也就是再小的号，只要你关注了它，它发的文章和大号是同等地位的，往下刷总是可以刷到。



不过现在公众号已经引入了乱序机制，你**越常读**、**越喜欢**的号，发的文章才有更大概率显示在前面并且被你刷到





